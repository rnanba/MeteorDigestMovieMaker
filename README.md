# MeteorDigestMovieMaker v0.2

## 概要

流星動画のファイル名と流星の出現位置(フレーム番号)を記録したテキストファイル(mdmmファィル)から、流星の出現箇所だけをまとめたダイジェスト動画を生成するツールです。タイムスタンプや流星のカウントを表示することもできます。

## 出力サンプル

https://www.flickr.com/photos/rnanba/53927622592/

## 動作環境

以下の環境で動作を確認しています。

- python 3.10.12
  - av 12.3.0
  - numpy 2.0.1
  - opencv-python 4.10.0.84
  - pillow 10.4.0

venv 環境で `pip install -r requirments.txt` でモジュールをインストールして動作確認しています。

OS は Ubuntu 22.04 で動作を確認ています。Windows, macOS でも動くように作ってありますが確認はしていません。以下の使用例では Linux の bash でのコマンドラインを例示しています。

## 使用方法

```
usage: mdmm.py [-h] [--base-dir BASE_DIR] [--out-dir OUT_DIR]
               [--out-ext OUT_EXT] [--font FONT] [--font-size FONT_SIZE]
               [--font-color FONT_COLOR] [--text-position TEXT_POSITION]
               [--video-codec VIDEO_CODEC] [--video-bit-rate VIDEO_BIT_RATE]
               [--margin-before MARGIN_BEFORE] [--margin-after MARGIN_AFTER]
               [--cue CUE] [--localtime] [--meteor-count] [--no-timestamp]
               [--timestamp-only]
               mdmm_files [mdmm_files ...] frame_rate
```

### 入力ファイル(mdmm ファイル)の形式

mdmm ファイルは、どの動画ファィルのどのフレームに流星が写っているかを記述したテキストファイルです。MeteorDigestMovieMaker は、このファイルを読み込んで流星が写っている動画フレームを抜き出してカット編集して1本の動画として出力します(複数の mdmm ファイルを指定した場合は各 mdmm ファイルに対して1本の動画を出力します)。

#### パス指定行

行頭が1個または連続した複数個の `#` で始まる行はディレクトリ名またはファイル名を指定する行(パス指定行)です。パス指定行では行頭部分に続けてディレクトリ名またはファイル名を書きます。ディレクトリ名またはファイル名の前後の空白文字は無視されます。

パス指定行では行頭の `#` の個数でデイレクトリのネストレベルを表します。カレントディレクトリまたは後述する `--base-dir BASE_DIR` オプションで指定したディレクトリにあるファイルまたはディレクトリは、行頭の `#` が1個だけの行で指定します。

行頭が `##` の行では直近に書かれた行頭が `#` の行で指定されたディレクトリにあるファイル名またはディレクトリ名を指定します。同様に、行頭が `###` の行では行頭が `##` の行で指定されたディレクトリにあるファイル名またはディレクトリ名を指定します。同様のルールで任意の深さのディレクトリにあるファイル名を指定します。

#### 流星フレーム行

動画ファイル(SER ファィル)を指定した行に続けて流星が写っているフレーム番号の範囲を指定する行(流星フレーム行)を、流星一つに対して1行ずつ記述します。

流星フレーム行では、開始フレーム番号と終了フレーム番号を `:` で区切ったものを記述します。フレーム番号は1から始まる番号です([SERPlayer](https://github.com/cgarry/ser-player) の表示と同じです)。

#### 動画ファイル(SERファイル)の制限

- ベイヤー配列のカラーカメラで RAW8 または RAW16 で記録した動画にのみ対応しています。
  - SharpCap でキャプチャーした動画で動作確認しています。
- 動画にはフレームのタイムスタンプが記録されている必要があります。
  - SharpCap ではデフォルトで記録されるようです。
- 一つの mdmm ファイルに複数の動画ファイル名を指定する場合、各動画ファイルの画像サイズとフレームレートは一致させてください。
  - エラーチェックはしていないので一致していない場合の動作は不定です。

## 記述例

以下は入力ファイル(mdmmファイル)の例です。

```
# 2024-08-12
## Capture

### 22_19_11.ser
10227:10231
12875:12879

### 23_00_05.ser
984:987
1620:1630
5142:5146
13611:13620

# 2024-08-13
## Capture

### 00_01_24.ser
11399:11402
12679:12684
12862:12867
14287:14295

### 00_22_06.ser
1:15
1055:1058
3949:3955
8072:8075
11825:11830
```

### 出力ファイル名

デフォルトの出力ファイル名は入力ファイル名と同じで、動画フォーマットに対応する拡張子を付けたものになります。拡張子はデフォルトでは `.mp4` です。

`--no-timestamp` オプションを指定した場合は入力ファイル名の末尾に `_notimestamp` を、`--timestamp-only` オプションを指定した場合は入力ファイル名の末尾に `_timestamp` を付けたファイル名になります。

###  引数

| 引数         | 説明                                                                                                                                         |
|--------------|----------------------------------------------------------------------------------------------------------------------------------------------|
| `mdmm_files` | 入力する mdmm ファイルを指定します。複数指定するとそれぞれについて一つの動画を生成します。ワイルドカードを使用したファイル名指定も可能です。 |
| `frame_rate` | 出力動画のフレームレートを指定します。                                                                                                       |

### オプション

| オプション                        | 説明                                                                                                                                      | デフォルト値 |
|-----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|--------------|
| `--base-dir BASE_DIR`             | 入力ファイルのパス指定行の基準となるディレクトリを指定します。                                                                            | `.`          |
| `--out-dir OUTDIR`                | 出力動画の保存祭ディレクトリを指定します。                                                                                                | `.`          |
| `--out-ext OUT_EXT`               | 出力動画のフォーマットを拡張子で指定します。                                                                                              | `.mp4`       |
| `--font FONT`                     | タイムスタンプ表示のフォントを指定します。指定がなければ環境から推定した Courier New フォントを使用します(後述)。                         | `24`         |
| `--font-size FONT_SIZE`           | タイムスタンプ表示のフォントサイズを指定します(単位はピクセル)。                                                                          |              |
| `--font-color FONT_COLOR`         | タイムスタンプ表示の文字色を指定します。HTML/CSSのカラーコードが使えます。                                                                | `#FF8888`    |
| `--text-position TEXT_POSITION`   | タイムスタンプの表示位置を `top-left`, `top-middle`, `top-right`, `bottom-left`, `bottom-middle`, `bottom-right` のいずれかで指定します。 | `top-left`   |
| `--video-codec VIDEO_CODEC`       | 出力動画のコーデックを ffmpeg のコーデック名で指定します。                                                                                | `libx264`    |
| `--video-bit-rate VIDEO_BIT_RATE` | 出力動画のビットレート(単位はbps)を指定します。                                                                                           | `12M`        |
| `--margin-before MARGIN_BEFORE`   | 流星出現前の何秒前まで出力に含めるかを指定します。                                                                                        | `2.0`        |
| `--margin-after MARGIN_AFTER`     | 流星消失後の何秒後まで出力に含めるかを指定します。                                                                                        | `2.0`        |
| `--cue CUE`                       | シーンのつなぎ目を表すマーク(タイムスタンプの下線)を何秒間表示するかを指定します。                                                        | `0.5`        |
| `--localtime`                     | タイムスタンプを実行環境のローカルタイムゾーンの時刻に変換して表示します。                                                                |              |
| `--meteor-count`                  | タイムスタンプの手前に流星カウント(再生位置までに流れた流星の数)を表示する場合に指定します。                                              |              |
| `--no-timestamp`                  | タイムスタンプと流星カウントを表示しない流星だけの映像を出力します(後述)。                                                                |              |
| `--timestamp-only`                | 黒バックにタイムスタンプと流星カウントだけを表示した映像を出力します(後述)。                                                              |              |

### フォントについて

デフォルトでは Windows, Linux(Ubuntu 等のディストリビューション), macOS がシステムに標準で持つ Courier New フォントを使用します。他の OS では明示的に `--font FONT` オプションを指定しないとエラーになります。`FONT` に指定するのは TrueType フォントのフォントファイル名です。詳細は[Pillow の ImageFont の説明](https://pillow.readthedocs.io/en/stable/reference/ImageFont.html)を参照してください。

### 使用例

mdmm ファイル `input.mdmm.txt` を元にフレームレート 15.9 fps のダイジェスト動画を出力するには以下のようにします。出力ファイル名は `input.mdmm.mp4` になります。

```
./mdmm.py input.mdmm.txt 15.9
```

mdmm ファイルに書かれたパスの基準となるディレクトリに `/SharpCap Captures` を指定する場合は以下のようにします。

```
./mdmm.py input.mdmm.txt 15.9 --base-dir '/SharpCap Captures'
```

## ライセンス

MITライセンスです。

## 参考: タイムスタンプと流星の分離処理

タイムスタンプのみの動画と流星のみの動画を生成することができます。流星のみの動画を画質調整したものにタイムスタンプのみの動画をクロマキー合成することでタイムスタンプの色調等に影響を与えずに画質調整することができます。タイムスタンプのみの動画の生成は流星を含む動画よりも高速に実行できるため、タイムスタンプのスタイルを後から変更する場合にもこの方法は便利です。

例:

```
./mdmm.py sample.mdmm.txt 15.9 --timestamp-only 
# -> sample.mdmm_timestamp.mp4
./mdmm.py sample.mdmm.txt 15.9 --no-timestamp
# -> sample.mdmm_notimestamp.mp4
ffmpeg -i sample.mdmm_notimestamp.mp4 -i sample.mdmm_timestamp.mp4 -filter_complex "[1]colorkey=black:0.01:0[a];[0]colorbalance=gm=-0.1:bm=-0.11:gs=-0.1:bs=-0.11:gh=-0.05:bh=-0.06,eq=gamma=0.97,hqdn3d[b];[b][a]overlay" -pix_fmt yuv420p sample.mdmm_merge.mp4
# -> sample.mdmm_merge.mp4
```

フィルター処理の説明は以下の通りです。

- 入力`[0]`のフィルター処理(`[a]`に出力)
  - `colorkey=black:0.01:0`
	- クロマキー合成で黒を透過させる指定
- 入力`[1]`のフィルター処理(`[b]`に出力)
  - `colorbalance=gm=-0.1:bm=-0.11:gs=-0.1:bs=-0.11:gh=-0.05:bh=-0.06`
	- カラーバランス調整
  - `eq=gamma=0.97`
	- ガンマ補正
  - `hqdn3d`
	- ノイズリダクション
- フィルター出力`[a]`,`[b]`の合成処理
  - `overlay`
	- オーバーレイ合成
